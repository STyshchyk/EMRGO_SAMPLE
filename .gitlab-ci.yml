# TODO: cleanup/refactor
# NOTE: VALID TARGET_APP_NAME values:
#   client-accounts, client-authentication, client-primaries
#   silver-administration, silver-authentication, silver-dataroom, silver-onboarding, silver-primaries

include:
  - local: .gitlab/ci/build_and_deploy.gitlab-ci.yml
  - local: .gitlab/ci/rules.gitlab-ci.yml

variables:
  DOCKER_REGISTRY_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_IMMUTABLE_IMAGE_TAG: $CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA-$TARGET_APP_NAME
  DOCKER_NODE_IMAGE: "node:19-bullseye"

image: "docker:latest"
services:
  - "docker:dind"

stages:
  - deploy

Deploy:client-authentication-EXP-DIFC:
  variables:
    TARGET_APP_NAME: "client-authentication"
    APP_SUBDOMAIN: "silver-auth"
  stage: deploy
  environment:
    name: exp-difc
  extends:
    - .build_and_deploy_config
    - .client_auth_build_rules_develop

Deploy:client-primaries-EXP-DIFC:
  variables:
    TARGET_APP_NAME: "client-primaries"
    APP_SUBDOMAIN: "silver-primaries"
  stage: deploy
  environment:
    name: exp-difc
  extends:
    - .build_and_deploy_config
    - .client_primaries_build_rules_develop

Deploy:silver-admin-EXP-DIFC:
  variables:
    TARGET_APP_NAME: "silver-administration"
    APP_SUBDOMAIN: "internal-silver-admin"
  stage: deploy
  environment:
    name: exp-difc
  extends:
    - .build_and_deploy_config
    - .silver-admin_build_rules_develop

Deploy:silver-auth-EXP-DIFC:
  variables:
    TARGET_APP_NAME: "silver-authentication"
    APP_SUBDOMAIN: "internal-silver-auth"
  stage: deploy
  environment:
    name: exp-difc
  extends:
    - .build_and_deploy_config
    - .silver-auth_build_rules_develop

Deploy:silver-dataroom-EXP-DIFC:
  variables:
    TARGET_APP_NAME: "silver-dataroom"
    APP_SUBDOMAIN: "internal-silver-dataroom"
  stage: deploy
  environment:
    name: exp-difc
  extends:
    - .build_and_deploy_config
    - .silver-dataroom_build_rules_develop

Deploy:silver-onboarding-EXP-DIFC:
  variables:
    TARGET_APP_NAME: "silver-onboarding"
    APP_SUBDOMAIN: "internal-silver-onboarding"
  stage: deploy
  environment:
    name: exp-difc
  extends:
    - .build_and_deploy_config
    - .silver-onboarding_build_rules_develop

Deploy:silver-prim-EXP-DIFC:
  variables:
    TARGET_APP_NAME: "silver-primaries"
    APP_SUBDOMAIN: "internal-silver-prim"
  stage: deploy
  environment:
    name: exp-difc
  extends:
    - .build_and_deploy_config
    - .silver-prim_build_rules_develop
