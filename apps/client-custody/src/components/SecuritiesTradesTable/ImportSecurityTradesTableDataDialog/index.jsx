import { useCallback, useMemo } from "react";
import { useDropzone } from "react-dropzone";
import { useSelector } from "react-redux";
import { toast } from "react-toastify";

import CloseIcon from "@mui/icons-material/Close";
import Dialog from "@mui/material/Dialog";
import DialogActions from "@mui/material/DialogActions";
import DialogContent from "@mui/material/DialogContent";
import DialogTitle from "@mui/material/DialogTitle";
import Grid from "@mui/material/Grid";
import IconButton from "@mui/material/IconButton";
import Typography from "@mui/material/Typography";
import moment from "moment";
import { parse } from "papaparse";
import PropTypes from "prop-types";

import { DEFAULT_DATE_FORMAT } from "../../../constants/datetime";
import * as externalSecuritiesSelectors from "../../../redux/selectors/externalSecurities";

const ALLOWED_FILE_TYPES = "text/csv";

const baseStyle = {
  flex: 1,
  display: "flex",
  flexDirection: "column",
  alignItems: "center",
  padding: "10px",
  borderWidth: 1,
  borderRadius: 0,
  borderColor: "#02075d",
  borderStyle: "dashed",
  backgroundColor: "#fafafa",
  color: "#02075d",
  outline: "none",
  transition: "border .24s ease-in-out",
};

const focusedStyle = {
  borderColor: "#2196f3",
};

const acceptStyle = {
  borderColor: "#00e676",
};

const rejectStyle = {
  borderColor: "#ff1744",
};

const getSecurityType = (inputtedIsin, exList) => {
  const selectedExtSecurity = exList.find((v) => v?.isin === inputtedIsin);

  if (!selectedExtSecurity?.id) {
    toast.error(`External Security doesn't exist`);
    return null;
  }

  return selectedExtSecurity?.assetTypeName?.key;
};

const parseCsvData = (csvString, externalSecuritiesList) => {
  const { data } = parse(csvString);

  // const datetime = '04/10/2022 12:18:15';
  // const res1 = moment(datetime, 'DD/MM/YYYY HH:mm:ss');
  // const res2 = res1.toISOString();
  let skippedFirst = false;
  data.splice(0, 1);
  const resultingData = data
    .map((arrItem) => {
      if (arrItem.length === 14) {
        // if (!skippedFirst) {
        //   skippedFirst = true;
        //   return null;
        // }
        const [
          portfolioAccountNumber,
          settlementType,
          isin,
          currency,
          tradeDate,
          settlementDate,
          quantity,
          price,
          principalAmount,
          accruedInterest,
          settlementAmount,
          counterparty,
          counterpartySSI,
          internalTradeRef,
        ] = arrItem;

        // if (!settlementType || !isin || !currency || !internalTradeRef) return null;

        const isEquityType = getSecurityType(isin, externalSecuritiesList) === "equity";
        // console.log(securityType);

        return {
          portfolioAccountNumber,
          settlementType,
          isin,
          currency,
          tradeDate: moment(tradeDate, "DD/MM/YYYY").toISOString(),
          settlementDate: moment(settlementDate, "DD/MM/YYYY").toISOString(),
          quantity,
          price,
          principalAmount,
          accruedInterest: isEquityType ? null : accruedInterest,
          commission: isEquityType ? accruedInterest : null,
          settlementAmount,
          counterparty,
          counterpartySSI,
          internalTradeRef,
          isEquityType,
        };
      }

      return null;
    })
    .filter((item) => {
      if (item) {
        return true;
      }
      return false;
    });

  return resultingData;
};

const ImportSecurityTradesTableDataDialog = ({
  open,
  handleClose,
  setTableData,
  tableData,
  setHasImportedData,
}) => {
  const externalSecuritiesList = useSelector(
    externalSecuritiesSelectors.selectExternalSecuritiesList
  );

  const onDrop = useCallback((acceptedFiles) => {
    const file = acceptedFiles[0];
    const fileType = file.type;

    const isFileTypeCSV = fileType === "text/csv";

    const reader = new FileReader();

    reader.onload = () => {
      const fileData = reader.result;
      console.log("fileData:: ", fileData);
      let parsed = [];

      if (isFileTypeCSV) {
        parsed = parseCsvData(fileData, externalSecuritiesList);
      }

      if (!parsed.length) {
        toast.error("CSV file has no data or is invalid");
        handleClose();
        return;
      }

      setHasImportedData(true);
      setTableData([...parsed, ...tableData]);

      handleClose();
    };

    if (isFileTypeCSV) {
      reader.readAsText(file);
    }
  }, []);

  const { getRootProps, getInputProps, isFocused, isDragAccept, isDragReject } = useDropzone({
    onDrop,
    maxFiles: 1,
    accept: ALLOWED_FILE_TYPES,
  });

  const style = useMemo(
    () => ({
      ...baseStyle,
      ...(isFocused ? focusedStyle : {}),
      ...(isDragAccept ? acceptStyle : {}),
      ...(isDragReject ? rejectStyle : {}),
    }),
    [isFocused, isDragAccept, isDragReject]
  );

  const placeholderText = "Drag 'n' drop some file here, or click to select file.";

  return (
    <Dialog
      disableEscapeKeyDown
      maxWidth="sm"
      open={open}
      onClose={(event, reason) => {
        if (reason && reason === "backdropClick") return;

        handleClose();
      }}
      aria-labelledby="form-dialog-title"
    >
      <DialogTitle>
        <Grid container justifyContent="space-between">
          <Grid item>
            <Typography
              variant="h6"
              style={{
                fontWeight: "bold",
              }}
            >
              Import CSV File
            </Typography>
          </Grid>
          <Grid item>
            <IconButton
              aria-label="close"
              onClick={() => {
                handleClose();
              }}
              size="large"
            >
              <CloseIcon />
            </IconButton>
          </Grid>
        </Grid>
      </DialogTitle>

      <DialogContent>
        <div {...getRootProps({ style })}>
          <input {...getInputProps()} />
          <p>{placeholderText}</p>
        </div>

        <Grid container direction="column">
          <div
            style={{
              marginTop: "1rem",
            }}
          >
            <Grid item>
              <Typography variant="button">
                <strong>ACCEPTABLE DATE FORMAT: </strong>
                {`${DEFAULT_DATE_FORMAT}`}
              </Typography>
            </Grid>
          </div>
        </Grid>
      </DialogContent>
      <DialogActions></DialogActions>
    </Dialog>
  );
};

export default ImportSecurityTradesTableDataDialog;

ImportSecurityTradesTableDataDialog.propTypes = {
  open: PropTypes.bool.isRequired,
  handleClose: PropTypes.func.isRequired,
  setTableData: PropTypes.func.isRequired,
};
